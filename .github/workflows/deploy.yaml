name: Deploy Microservices

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v1

    - name: Log in to Azure with service principal
      run: az login 


    - name: Run Creation.sh
      run: ./scripts/Creation.sh

    - name: Extract Terraform Outputs
      id: tf_outputs
      run: |
        echo "ACR_LOGIN_SERVER=$(terraform output -raw acr_login_server)" >> $GITHUB_ENV
        echo "ACR_USERNAME=$(terraform output -raw acr_admin_username)" >> $GITHUB_ENV
        echo "ACR_PASSWORD=$(terraform output -raw acr_admin_password)" >> $GITHUB_ENV

    - name: Install GitHub CLI
      run: |
        curl -s https://cli.github.com/install.sh | bash

    - name: Authenticate GitHub CLI
      run: gh auth login --with-token <<< ${{ secrets.GH_PAT }}

    - name: Update GitHub Secrets
      run: |
        gh secret set ACR_LOGIN_SERVER --body "${{ env.ACR_LOGIN_SERVER }}"
        gh secret set ACR_USERNAME --body "${{ env.ACR_USERNAME }}"
        gh secret set ACR_PASSWORD --body "${{ env.ACR_PASSWORD }}"

    - name: Log in to Azure Container Registry
      run: echo ${{ env.ACR_PASSWORD }} | docker login ${{ env.ACR_LOGIN_SERVER }} -u ${{ env.ACR_USERNAME }} --password-stdin
